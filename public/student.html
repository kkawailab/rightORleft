<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â≠¶ÁîüÁî®ÊäïÁ•®ÁîªÈù¢ - Right or Left</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', 'Hiragino Sans', 'Yu Gothic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 800px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .status {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 30px;
            font-weight: bold;
            font-size: 1.2em;
        }

        .status.waiting {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status.voting {
            background: #fff3e0;
            color: #f57c00;
        }

        .status.voted {
            background: #e8f5e9;
            color: #388e3c;
        }

        .voting-area {
            display: none;
            margin-bottom: 30px;
        }

        .voting-area.active {
            display: block;
        }

        .vote-buttons {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .vote-btn {
            flex: 1;
            padding: 60px 20px;
            font-size: 2em;
            border: 4px solid;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            background: white;
            position: relative;
            overflow: hidden;
        }

        .vote-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .vote-btn:active:not(:disabled) {
            transform: scale(0.98);
        }

        .vote-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .vote-btn.left {
            border-color: #e91e63;
            color: #e91e63;
        }

        .vote-btn.left:hover:not(:disabled) {
            background: #e91e63;
            color: white;
        }

        .vote-btn.right {
            border-color: #3f51b5;
            color: #3f51b5;
        }

        .vote-btn.right:hover:not(:disabled) {
            background: #3f51b5;
            color: white;
        }

        .vote-btn.selected {
            animation: pulse 0.5s;
        }

        .vote-btn.selected.left {
            background: #e91e63;
            color: white;
        }

        .vote-btn.selected.right {
            background: #3f51b5;
            color: white;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        .results-area {
            display: none;
        }

        .results-area.active {
            display: block;
        }

        .result-item {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .result-label {
            width: 100px;
            font-size: 1.3em;
            font-weight: bold;
        }

        .result-label.left {
            color: #e91e63;
        }

        .result-label.right {
            color: #3f51b5;
        }

        .result-bar-container {
            flex: 1;
            height: 50px;
            background: #f0f0f0;
            border-radius: 25px;
            overflow: hidden;
            position: relative;
        }

        .result-bar {
            height: 100%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2em;
        }

        .result-bar.left {
            background: linear-gradient(90deg, #e91e63, #f06292);
        }

        .result-bar.right {
            background: linear-gradient(90deg, #3f51b5, #5c6bc0);
        }

        .connection-status {
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 0.9em;
        }

        .connection-status.connected {
            background: #c8e6c9;
            color: #2e7d32;
        }

        .connection-status.disconnected {
            background: #ffcdd2;
            color: #c62828;
        }

        .message {
            text-align: center;
            padding: 15px;
            margin-top: 20px;
            border-radius: 10px;
            font-size: 1.1em;
            display: none;
        }

        .message.show {
            display: block;
        }

        .message.success {
            background: #c8e6c9;
            color: #2e7d32;
        }

        .message.info {
            background: #e3f2fd;
            color: #1976d2;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 1.5em;
            }

            .vote-buttons {
                flex-direction: column;
            }

            .vote-btn {
                padding: 40px 20px;
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üó≥Ô∏è ÊäïÁ•®„Ç∑„Çπ„ÉÜ„É†</h1>

        <div id="connectionStatus" class="connection-status disconnected">
            Êé•Á∂ö‰∏≠...
        </div>

        <div id="status" class="status waiting">
            ÊäïÁ•®ÈñãÂßã„Çí„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ
        </div>

        <div id="votingArea" class="voting-area">
            <div class="vote-buttons">
                <button id="leftBtn" class="vote-btn left">
                    ‚Üê Â∑¶ÂÅ¥
                </button>
                <button id="rightBtn" class="vote-btn right">
                    Âè≥ÂÅ¥ ‚Üí
                </button>
            </div>
        </div>

        <div id="resultsArea" class="results-area">
            <h2 style="text-align: center; margin-bottom: 20px; color: #333;">ÊäïÁ•®ÁµêÊûú</h2>
            <div class="result-item">
                <div class="result-label left">‚Üê Â∑¶ÂÅ¥</div>
                <div class="result-bar-container">
                    <div id="leftBar" class="result-bar left" style="width: 0%">
                        <span id="leftCount">0</span>
                    </div>
                </div>
            </div>
            <div class="result-item">
                <div class="result-label right">Âè≥ÂÅ¥ ‚Üí</div>
                <div class="result-bar-container">
                    <div id="rightBar" class="result-bar right" style="width: 0%">
                        <span id="rightCount">0</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="message" class="message"></div>
    </div>

    <script>
        let ws;
        let studentId = localStorage.getItem('studentId');
        let hasVoted = false;
        let myVote = null;

        if (!studentId) {
            studentId = 'student_' + Math.random().toString(36).substr(2, 9) + Date.now();
            localStorage.setItem('studentId', studentId);
        }

        function connect() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}`;

            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('WebSocketÊé•Á∂öÊàêÂäü');
                document.getElementById('connectionStatus').textContent = 'Êé•Á∂öÊ∏à„Åø';
                document.getElementById('connectionStatus').className = 'connection-status connected';

                // Â≠¶Áîü„Å®„Åó„Å¶ÁôªÈå≤
                ws.send(JSON.stringify({
                    type: 'register_student',
                    studentId: studentId
                }));
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('Âèó‰ø°:', data);

                switch(data.type) {
                    case 'voting_started':
                        handleVotingStarted();
                        break;
                    case 'vote_confirmed':
                        handleVoteConfirmed(data.choice);
                        break;
                    case 'results':
                        showResults(data);
                        break;
                    case 'reset':
                        handleReset();
                        break;
                    case 'error':
                        showMessage(data.message, 'info');
                        break;
                    case 'state_update':
                        // „Çµ„Éº„Éê„Éº„Åã„Çâ„ÅÆÁä∂ÊÖãÂêåÊúü
                        if (data.state.active) {
                            handleVotingStarted();
                        }
                        break;
                }
            };

            ws.onclose = () => {
                console.log('WebSocketÂàáÊñ≠');
                document.getElementById('connectionStatus').textContent = 'ÂàáÊñ≠„Åï„Çå„Åæ„Åó„Åü';
                document.getElementById('connectionStatus').className = 'connection-status disconnected';
                // ÂÜçÊé•Á∂ö„ÇíË©¶„Åø„Çã
                setTimeout(connect, 3000);
            };

            ws.onerror = (error) => {
                console.error('WebSocket„Ç®„É©„Éº:', error);
            };
        }

        function handleVotingStarted() {
            hasVoted = false;
            myVote = null;
            document.getElementById('status').textContent = 'ÊäïÁ•®„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
            document.getElementById('status').className = 'status voting';
            document.getElementById('votingArea').className = 'voting-area active';
            document.getElementById('resultsArea').className = 'results-area';
            document.getElementById('leftBtn').disabled = false;
            document.getElementById('rightBtn').disabled = false;
            document.getElementById('leftBtn').classList.remove('selected');
            document.getElementById('rightBtn').classList.remove('selected');
            hideMessage();
        }

        function vote(choice) {
            if (ws && ws.readyState === WebSocket.OPEN && !hasVoted) {
                ws.send(JSON.stringify({
                    type: 'vote',
                    choice: choice
                }));
            }
        }

        function handleVoteConfirmed(choice) {
            hasVoted = true;
            myVote = choice;
            document.getElementById('status').textContent = 'ÊäïÁ•®ÂÆå‰∫ÜÔºÅ';
            document.getElementById('status').className = 'status voted';
            document.getElementById('leftBtn').disabled = true;
            document.getElementById('rightBtn').disabled = true;

            // ÈÅ∏Êäû„Åó„Åü„Éú„Çø„É≥„Çí„Éè„Ç§„É©„Ç§„Éà
            if (choice === 'left') {
                document.getElementById('leftBtn').classList.add('selected');
            } else {
                document.getElementById('rightBtn').classList.add('selected');
            }

            showMessage('ÊäïÁ•®„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åó„ÅüÔºÅ', 'success');
        }

        function showResults(data) {
            document.getElementById('status').textContent = 'ÊäïÁ•®ÁµêÊûú';
            document.getElementById('status').className = 'status voted';
            document.getElementById('votingArea').className = 'voting-area';
            document.getElementById('resultsArea').className = 'results-area active';

            const total = data.totalVotes || 1; // „Çº„É≠Èô§ÁÆó„ÇíÈò≤„Åê
            const leftPercent = (data.leftCount / total * 100).toFixed(1);
            const rightPercent = (data.rightCount / total * 100).toFixed(1);

            document.getElementById('leftCount').textContent = `${data.leftCount} (${leftPercent}%)`;
            document.getElementById('rightCount').textContent = `${data.rightCount} (${rightPercent}%)`;
            document.getElementById('leftBar').style.width = leftPercent + '%';
            document.getElementById('rightBar').style.width = rightPercent + '%';

            hideMessage();
        }

        function handleReset() {
            hasVoted = false;
            myVote = null;
            document.getElementById('status').textContent = 'ÊäïÁ•®ÈñãÂßã„Çí„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ';
            document.getElementById('status').className = 'status waiting';
            document.getElementById('votingArea').className = 'voting-area';
            document.getElementById('resultsArea').className = 'results-area';
            document.getElementById('leftBtn').classList.remove('selected');
            document.getElementById('rightBtn').classList.remove('selected');
            hideMessage();
        }

        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message show ${type}`;
        }

        function hideMessage() {
            const messageEl = document.getElementById('message');
            messageEl.className = 'message';
        }

        // „Éú„Çø„É≥„Ç§„Éô„É≥„Éà
        document.getElementById('leftBtn').addEventListener('click', () => {
            vote('left');
        });

        document.getElementById('rightBtn').addEventListener('click', () => {
            vote('right');
        });

        // ÂàùÊúüÊé•Á∂ö
        connect();
    </script>
</body>
</html>
